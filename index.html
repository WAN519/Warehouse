<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Suggested Recommendations</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for beautiful charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* Set global font to Inter for clean aesthetics, using a silver/white theme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8; /* Very light silver-gray background */
        }
        /* Custom table styles for readability */
        .data-table th {
            @apply px-4 py-3 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider;
        }
        .data-table td {
            @apply px-4 py-3 text-sm text-gray-700 border-b border-gray-200;
        }
        /* Apple-style card: clean white background, subtle shadow, soft rounded corners */
        .apple-card {
            @apply bg-white p-6 rounded-xl shadow-lg shadow-gray-200/40 border border-gray-100 transition-all duration-300 hover:shadow-xl hover:shadow-gray-200/60;
        }
        /* Custom KPI number styling */
        .kpi-number {
            @apply text-3xl font-extrabold text-gray-900 mt-2;
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <!-- Header (Updated with Silver/White Gradient) -->
    <header class="mb-10">
        <div class="flex items-center mb-2">
            <!-- Icon: Stylized Bar Chart for Data/AI (Color changed to deep gray for contrast) -->
            <svg class="w-8 h-8 mr-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 2h12a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <!-- Title with gradient (Silver/White style) -->
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-gray-500 via-gray-900 to-gray-500">
                AI Suggested Recommendations
            </h1>
        </div>
        <p class="text-gray-500 pl-11" id="report-metadata">
            Analysis Date: <span id="analysis-date" class="font-medium text-gray-600">Loading...</span> |
            Analysis Period: <span id="analysis-period" class="font-medium text-gray-600">Loading...</span>
        </p>
    </header>

    <!-- Loading/Error Message -->
    <div id="loading" class="text-center p-12 apple-card">
        <svg class="animate-spin h-6 w-6 text-gray-500 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-600">Loading data...</p>
    </div>
    <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
        <strong class="font-bold">Data Loading Failed!</strong>
        <span class="block sm:inline" id="error-details"></span>
        <p class="text-sm mt-2">Please check if the backend service (Flask) is running correctly and ensure the data structure is valid.</p>
    </div>

    <!-- Main Content -->
    <main id="content" class="space-y-12 hidden">

        <!-- 1. AI Promotional Strategy Suggestions (PRIMARY FOCUS) -->
        <section>
            <h2 class="text-3xl font-bold text-gray-900 mb-6 border-b pb-2">AI Promotional Strategy Recommendations</h2>
            <div class="apple-card p-8 overflow-x-auto text-lg" id="suggestions-container">
                <!-- Suggestions table will be rendered here -->
            </div>
        </section>

        <!-- 2. Summary Metrics (Smaller KPIs) -->
        <section>
            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Key Inventory Metrics Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Card 1: Total Slow Products (KPI color kept as Brown/Warm from previous request) -->
                <div class="apple-card">
                    <p class="text-sm font-medium text-gray-500">Total Slow-Moving Products</p>
                    <p class="kpi-number text-amber-700" id="total-slow-products">0</p>
                    <p class="text-xs text-gray-400 mt-2">Below 50% sell-through threshold</p>
                </div>

                <!-- Card 2: High Stock Percentage (KPI color kept as Brown/Warm from previous request) -->
                <div class="apple-card">
                    <p class="text-sm font-medium text-gray-500">High Stock Percentage</p>
                    <p class="kpi-number text-amber-700" id="high-stock-percentage">0%</p>
                    <p class="text-xs text-gray-400 mt-2">Among products > 7 days in stock</p>
                </div>

                <!-- Card 3: Average Stock Quantity (KPI color kept as Brown/Warm from previous request) -->
                <div class="apple-card">
                    <p class="text-sm font-medium text-gray-500">Avg. Slow-Moving Product Stock</p>
                    <p class="kpi-number text-amber-700" id="avg-stock">0.00</p>
                    <p class="text-xs text-gray-400 mt-2">Average accumulated stock quantity</p>
                </div>
            </div>
        </section>

        <!-- 3. Charts Section (Reduced Height) -->
        <section>
            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Inventory Distribution Visualization</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chart 1: Days In Stock Distribution -->
                <div class="apple-card h-80">
                    <h3 class="text-base font-semibold mb-2 text-gray-700">Days In Stock Distribution</h3>
                    <canvas id="daysInStockChart" class="h-full"></canvas>
                </div>
                <!-- Chart 2: Top 5 Worst Sell-Through Rates -->
                <div class="apple-card h-80">
                    <h3 class="text-base font-semibold mb-2 text-gray-700">Top 5 Products with Lowest Sell-Through Rates</h3>
                    <canvas id="sellThroughChart" class="h-full"></canvas>
                </div>
            </div>
        </section>

        <!-- 4. Detailed Slow-Moving Products Table -->
        <section>
            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Detailed Slow-Moving Products List</h2>
            <div class="apple-card p-0 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 data-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th>Product Name (ID)</th>
                            <th>Manufacturer/Supplier</th>
                            <th>Days In Stock</th>
                            <th>Current Stock</th>
                            <th>Supply Quantity</th>
                            <th>Price</th>
                            <th>Sell-Through Rate</th>
                            <th>Warehouse ID</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body" class="divide-y divide-gray-200">
                        <!-- Product rows will be inserted here -->
                        <tr><td colspan="8" class="text-center py-8 text-gray-500">Loading slow-moving product data...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <script type="module">
        // Firebase Auth Setup (Mandatory in Canvas environment)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.error("Firebase Custom Auth failed, signing in anonymously:", e);
                    signInAnonymously(auth);
                });
            } else {
                signInAnonymously(auth);
            }
        }
        // End of Firebase Setup

        /**
         * Parses the complex Markdown table string into a functional HTML table.
         * Handles the nested list items within the 'Promotional Strategy' column.
         * @param {string} markdownContent - The raw suggestions string containing the markdown table.
         * @returns {string} - HTML string of the table.
         */
        function parseMarkdownTable(markdownContent) {
            if (!markdownContent) return "<p class='text-gray-500'>No promotional suggestions available.</p>";

            const lines = markdownContent.split('\n');
            // Find the table header line (starts with |)
            const tableStart = lines.findIndex(line => line.trim().startsWith('|') && !line.includes('---'));
            if (tableStart === -1) return "<p class='text-gray-500'>Unable to parse suggestions table content.</p>";

            // Extract Header and Separator (first 2 lines after start)
            const headerLine = lines[tableStart];
            const separatorLine = lines[tableStart + 1];
            if (!separatorLine || !separatorLine.includes('---')) return "<p class='text-gray-500'>Unable to parse suggestions table format.</p>";

            const bodyLines = lines.slice(tableStart + 2);

            // 1. Process Header
            let headers = headerLine.split('|').map(h => h.trim()).filter(h => h);

            const tableHeaderHtml = `
                <thead>
                    <tr class="bg-gray-100">
                        ${headers.map(h => `<th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">${h.replace(/\*\*/g, '')}</th>`).join('')}
                    </tr>
                </thead>
            `;

            // 2. Process Body
            let tableBodyHtml = '<tbody>';

            for (const line of bodyLines) {
                if (!line.trim().startsWith('|')) continue; // Skip non-table lines

                // Split the row by '|'. Filter out empty strings from the start/end split
                const cells = line.split('|').map(c => c.trim()).filter((c, i, arr) => (i > 0 && i < arr.length - 1));

                if (cells.length !== headers.length) continue; // Skip malformed rows

                let rowHtml = '<tr>';
                cells.forEach((cell, index) => {
                    let cellContent = cell;

                    // Simple Markdown to HTML conversion for the Strategy column (index 2)
                    if (index === 2) {
                        // Replace <br> with <br>
                        cellContent = cellContent.replace(/<br>/g, '<br/>');

                        const listItems = cellContent.split('<br/>').map(item => item.trim()).filter(item => item);

                        if (listItems.length > 0) {
                            cellContent = '<ul class="list-disc pl-5 space-y-1">';
                            listItems.forEach(item => {
                                // Clean up the list marker (e.g., '1. ', '2. ')
                                const cleanItem = item.replace(/^\s*\d+\.\s*/, '');
                                // Convert bold markdown **...** to <strong>
                                const htmlItem = cleanItem.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                cellContent += `<li class="text-base leading-snug">${htmlItem}</li>`; // Use base font size for suggestions
                            });
                            cellContent += '</ul>';
                        }
                    } else {
                        // Basic bold conversion for other cells
                        cellContent = cellContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    }

                    rowHtml += `<td class="px-4 py-3 align-top border-b border-gray-200">${cellContent}</td>`;
                });
                rowHtml += '</tr>';
                tableBodyHtml += rowHtml;
            }

            tableBodyHtml += '</tbody>';

            return `<table class="min-w-full divide-y divide-gray-200">${tableHeaderHtml}${tableBodyHtml}</table>`;
        }

        /**
         * Renders the main summary metrics (KPI cards).
         * @param {object} products - The products object from the JSON response.
         */
        function renderSummary(products) {
            const performance = products.category_performance[0] || {};

            document.getElementById('analysis-date').textContent = products.analysis_date || 'N/A';
            document.getElementById('analysis-period').textContent = products.analysis_period || 'N/A';

            document.getElementById('total-slow-products').textContent = products.total_slow_products || '0';

            // Format numbers
            const percentFormat = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const numberFormat = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Ensure high_stock_percentage is treated as a number/string that can be parsed
            const highStockPercent = parseFloat(performance.high_stock_percentage) / 100;
            document.getElementById('high-stock-percentage').textContent = isNaN(highStockPercent) ? '0%' : percentFormat.format(highStockPercent);

            document.getElementById('avg-stock').textContent = numberFormat.format(parseFloat(performance.avg_stock) || 0);
        }

        /**
         * Renders the detailed table of slow-moving products.
         * @param {Array} slowMovingProducts - Array of slow-moving product objects.
         */
        function renderProductTable(slowMovingProducts) {
            const tbody = document.getElementById('products-table-body');
            tbody.innerHTML = ''; // Clear loading message

            if (!slowMovingProducts || slowMovingProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">Great! No slow-moving products found currently.</td></tr>';
                return;
            }

            const currencyFormat = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const percentFormat = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 });

            slowMovingProducts.forEach(product => {
                const row = tbody.insertRow();
                // Apply a mild warning color to products with very low/negative sell-through rate
                const sellThrough = parseFloat(product.sell_through_rate) / 100;

                // Using silver/gray tones for warning, keeping red for severe issues
                if (sellThrough <= -0.05) { // e.g. -5% or lower
                    row.classList.add('bg-red-50');
                } else if (sellThrough < 0) {
                    row.classList.add('bg-gray-100'); // Light gray for mild warning (silver theme)
                } else {
                    row.classList.add('hover:bg-gray-50');
                }


                // Product Name / ID
                row.insertCell().innerHTML = `
                    <div class="font-semibold text-gray-900">${product.product_name}</div>
                    <div class="text-gray-500 text-xs">${product.product_id}</div>
                `;
                // Manufacturer / Supplier
                row.insertCell().innerHTML = `
                    <div class="font-medium">${product.manufacturer}</div>
                    <div class="text-gray-500 text-xs">Supp: ${product.supplier_id}</div>
                `;
                // Days In Stock
                row.insertCell().textContent = product.days_in_stock || 'N/A';
                // Stock Quantity
                row.insertCell().textContent = product.stock_quantity || '0';
                // Supply Quantity
                row.insertCell().textContent = product.supply_quantity || '0';
                // Price
                row.insertCell().textContent = currencyFormat.format(parseFloat(product.price) || 0);
                // Sell Through Rate
                const sellThroughCell = row.insertCell();
                sellThroughCell.textContent = isNaN(sellThrough) ? 'N/A' : percentFormat.format(sellThrough);
                sellThroughCell.classList.add('font-bold');

                // Warehouse ID
                row.insertCell().textContent = product.warehouse_id || 'N/A';
            });
        }

        /**
         * Renders the two Chart.js graphs.
         * @param {Array} slowMovingProducts - Array of slow-moving product objects.
         */
        function renderCharts(slowMovingProducts) {
            if (!slowMovingProducts || slowMovingProducts.length === 0) {
                console.log("No slow-moving products to render charts.");
                document.getElementById('daysInStockChart').parentElement.innerHTML = '<p class="text-center text-gray-500 p-8">No data available for analysis.</p>';
                document.getElementById('sellThroughChart').parentElement.innerHTML = '<p class="text-center text-gray-500 p-8">No data available for analysis.</p>';
                return;
            }

            // Set Chart.js Defaults for a cleaner look
            Chart.defaults.font.family = 'Inter';
            Chart.defaults.color = '#374151'; // Gray-700

            // --- Silver/Gray Tones Palette (Modern, monochromatic colors) ---
            const silverGrayColors = [
                '#4B5563', // Gray-600 (Dark Silver)
                '#9CA3AF', // Gray-400 (Medium Silver)
                '#374151', // Gray-700 (Darker for contrast)
                '#D1D5DB', // Gray-300 (Light Silver)
                '#1F2937', // Gray-800 (Nearly Black for emphasis)
            ];


            // --- Chart 1: Days In Stock Distribution (Doughnut Chart) ---
            const stockDistribution = {
                '0-30 Days': 0,
                '31-90 Days': 0,
                '91-180 Days': 0,
                '180+ Days': 0,
            };

            slowMovingProducts.forEach(p => {
                const days = parseInt(p.days_in_stock) || 0;
                if (days <= 30) {
                    stockDistribution['0-30 Days']++;
                } else if (days <= 90) {
                    stockDistribution['31-90 Days']++;
                } else if (days <= 180) {
                    stockDistribution['91-180 Days']++;
                } else {
                    stockDistribution['180+ Days']++;
                }
            });

            const chart1Data = {
                labels: Object.keys(stockDistribution),
                datasets: [{
                    data: Object.values(stockDistribution),
                    // Apply Silver/Gray colors for doughnut chart
                    backgroundColor: silverGrayColors.slice(0, 4),
                    hoverOffset: 6
                }]
            };

            new Chart(document.getElementById('daysInStockChart'), {
                type: 'doughnut',
                data: chart1Data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Important for fixed height h-80
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { boxWidth: 10 }
                        },
                        title: { display: false }
                    },
                    cutout: '75%', // Make it a thinner ring
                }
            });

            // --- Chart 2: Top 5 Worst Sell-Through Rates (Bar Chart) ---
            const sortedProducts = [...slowMovingProducts]
                .sort((a, b) => parseFloat(a.sell_through_rate) - parseFloat(b.sell_through_rate))
                .slice(0, 5);

            const chart2Data = {
                labels: sortedProducts.map(p => p.product_name),
                datasets: [{
                    label: 'Sell-Through Rate (%)',
                    data: sortedProducts.map(p => parseFloat(p.sell_through_rate)),
                    // Use a single, deep Silver/Gray color for the bar chart
                    backgroundColor: silverGrayColors[0],
                    borderRadius: 4,
                }]
            };

            new Chart(document.getElementById('sellThroughChart'), {
                type: 'bar',
                data: chart2Data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Important for fixed height h-80
                    indexAxis: 'y', // Horizontal bars for better readability
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.dataset.label}: ${context.parsed.x.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Sell-Through Rate (%)', font: { size: 12 } },
                            beginAtZero: false,
                            grid: { color: '#e5e7eb' }
                        },
                        y: {
                            title: { display: false },
                            grid: { display: false }
                        }
                    }
                }
            });
        }


        /**
         * Main function to fetch data and coordinate rendering.
         */
        async function fetchData() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            const errorDiv = document.getElementById('error-message');
            const errorDetails = document.getElementById('error-details');

            loading.classList.remove('hidden');
            content.classList.add('hidden');
            errorDiv.classList.add('hidden');

            try {
                // Implementing exponential backoff for API call
                let data = null;
                const maxRetries = 3;
                let retryCount = 0;
                const API_BASE_URL = 'https://inventory-analysis-api.onrender.com';

                while (retryCount < maxRetries) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/report`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        data = await response.json();
                        break; // Success, exit loop
                    } catch (error) {
                        retryCount++;
                        if (retryCount >= maxRetries) {
                            throw error; // Throw error after max retries
                        }
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        // Do not log retry attempts as errors
                    }
                }

                const products = data.products;
                const suggestionsMarkdown = data.suggestions;

                // 1. Render Suggestions (Markdown Table) - Moved up for priority
                const suggestionsHtml = parseMarkdownTable(suggestionsMarkdown);
                document.getElementById('suggestions-container').innerHTML = suggestionsHtml;

                // 2. Render Summary (KPI Cards)
                renderSummary(products);

                // 3. Render Charts
                renderCharts(products.slow_moving_products);

                // 4. Render Detailed Table
                renderProductTable(products.slow_moving_products);

                // Show content
                content.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching data:", error);
                errorDetails.textContent = `Details: ${error.message}`;
                errorDiv.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', fetchData);

    </script>
</body>
</html>